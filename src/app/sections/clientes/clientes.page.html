<section class="layout" aria-label="Gesti√≥n de Clientes">
  <app-sidebar></app-sidebar>
  <main class="content">
    <header class="header">
      <div>
        <h1>Clientes</h1>
        <small class="muted">Gesti√≥n de clientes y contactos</small>
      </div>
      <div class="acciones">
        <button class="btn btn--secondary" type="button" (click)="busqueda.set(''); tipoFiltro.set('todos')">Limpiar filtros</button>
        <button class="btn btn--primary" type="button" (click)="openModal()">+ Nuevo Cliente</button>
      </div>
    </header>

    <section class="filtros card">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
          <label>
            Buscar por
            <select [ngModel]="campoBusqueda()" (ngModelChange)="campoBusqueda.set($event)">
              <option value="nombre">Nombre</option>
              <option value="documento">Documento</option>
              <option value="email">Email</option>
            </select>
          </label>
        </div>
        <div>
          <label>
            Buscar
            <input type="text" placeholder="Escribe para buscar..." [ngModel]="busqueda()" (ngModelChange)="busqueda.set($event)" />
          </label>
        </div>
        <div>
          <label>
            Estado
            <select [ngModel]="tipoFiltro()" (ngModelChange)="tipoFiltro.set($event)">
              <option value="todos">Todos</option>
              <option value="activo">Activos</option>
              <option value="inactivo">Inactivos</option>
            </select>
          </label>
        </div>
      </div>
    </section>

    <section class="tabla" aria-label="Lista de clientes">
      <ng-container *ngIf="filtered().length; else vacio">
        <div class="table card">
          <div class="row header">
            <div>Documento</div>
            <div>Nombre / Raz√≥n Social</div>
            <div>Contacto</div>
            <div>Estado</div>
            <div>Fecha Registro</div>
            <div>Acciones</div>
          </div>
          <div class="row" *ngFor="let c of filtered(); let i = index" [class.alt]="i % 2 === 1">
            <div>
              <div style="font-weight: 600;">{{ c.tipoDocumento }}</div>
              <div class="muted" style="font-size: 0.875rem;">{{ c.numeroDocumento }}</div>
            </div>
            <div>
              <div style="font-weight: 600;">{{ c.nombre }}</div>
              <div class="muted" style="font-size: 0.875rem;" *ngIf="c.razonSocial">{{ c.razonSocial }}</div>
            </div>
            <div>
              <div *ngIf="c.telefono" class="muted" style="font-size: 0.875rem;">üìû {{ c.telefono }}</div>
              <div *ngIf="c.email" class="muted" style="font-size: 0.875rem;">‚úâÔ∏è {{ c.email }}</div>
              <div *ngIf="c.direccion" class="muted" style="font-size: 0.875rem;">üìç {{ c.direccion }}</div>
            </div>
            <div>
              <span class="badge" [class.badge--success]="c.estado === 'activo'" [class.badge--muted]="c.estado === 'inactivo'">
                {{ c.estado === 'activo' ? 'Activo' : 'Inactivo' }}
              </span>
            </div>
            <div class="muted" style="font-size: 0.875rem;">{{ c.fechaRegistro }}</div>
            <div class="acciones-row" style="display: flex; gap: 8px;">
              <button class="btn btn--secondary" type="button" (click)="openModal(c)">Editar</button>
              <button class="btn btn--danger" type="button" (click)="deleteCliente(c.id)">Eliminar</button>
            </div>
          </div>
        </div>
      </ng-container>
      <ng-template #vacio>
        <div class="callout" role="status">No hay clientes que coincidan con la b√∫squeda.</div>
      </ng-template>
    </section>
  </main>
</section>

<div class="modal-overlay" *ngIf="showModal()" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editingCliente() ? 'Editar Cliente' : 'Nuevo Cliente' }}</h2>
      <button class="btn btn--secondary" type="button" (click)="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
        <div>
          <label>
            Tipo de Documento
            <select [ngModel]="formData().tipoDocumento" (ngModelChange)="updateFormField('tipoDocumento', $event)">
              <option value="DNI">DNI</option>
              <option value="RUC">RUC</option>
              <option value="CE">CE</option>
            </select>
          </label>
        </div>
        <div>
          <label>
            N√∫mero de Documento *
            <div class="documento-input-wrapper">
              <input 
                type="text" 
                [ngModel]="formData().numeroDocumento" 
                (ngModelChange)="validarDNI(); updateFormField('numeroDocumento', $event)"
                [placeholder]="formData().tipoDocumento === 'DNI' ? '12345678' : '20123456789'"
                [maxlength]="formData().tipoDocumento === 'DNI' ? 8 : 11"
                required />
              <button
                *ngIf="(formData().tipoDocumento === 'DNI' || formData().tipoDocumento === 'RUC') && formData().numeroDocumento"
                type="button"
                class="btn-sunat"
                [disabled]="buscandoSunat()"
                (click)="buscarEnSunat()"
                [title]="'Buscar datos en SUNAT'"
                aria-label="Buscar datos en SUNAT">
                <span *ngIf="!buscandoSunat()">üîç Buscar SUNAT</span>
                <span *ngIf="buscandoSunat()">‚è≥ Buscando...</span>
              </button>
            </div>
            <small class="sunat-hint" *ngIf="formData().tipoDocumento === 'DNI' || formData().tipoDocumento === 'RUC'">
              Ingresa el {{ formData().tipoDocumento }} y haz clic en "Buscar SUNAT" para obtener los datos autom√°ticamente
            </small>
          </label>
        </div>
        <div>
          <label>
            Nombre *
            <input type="text" [ngModel]="formData().nombre" (ngModelChange)="updateFormField('nombre', $event)" required />
          </label>
        </div>
        <div *ngIf="formData().tipoDocumento === 'RUC'">
          <label>
            Raz√≥n Social
            <input type="text" [ngModel]="formData().razonSocial" (ngModelChange)="updateFormField('razonSocial', $event)" />
          </label>
        </div>
        <div>
          <label>
            Tel√©fono
            <input type="text" [ngModel]="formData().telefono" (ngModelChange)="updateFormField('telefono', $event)" />
          </label>
        </div>
        <div>
          <label>
            Email
            <input type="email" [ngModel]="formData().email" (ngModelChange)="updateFormField('email', $event)" />
          </label>
        </div>
        <div style="grid-column: 1 / -1;">
          <label>
            Direcci√≥n
            <input type="text" [ngModel]="formData().direccion" (ngModelChange)="updateFormField('direccion', $event)" />
          </label>
        </div>
        <div>
          <label>
            Estado
            <select [ngModel]="formData().estado" (ngModelChange)="updateFormField('estado', $event)">
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
            </select>
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn--secondary" type="button" (click)="closeModal()">Cancelar</button>
      <button class="btn btn--primary" type="button" (click)="saveCliente()">Guardar</button>
    </div>
  </div>
</div>