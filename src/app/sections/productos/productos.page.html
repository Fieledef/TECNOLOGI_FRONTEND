<section class="layout" aria-label="Productos y Servicios">
  <app-sidebar></app-sidebar>
  <main class="content">
    <header class="header">
      <div>
        <h1>Productos y Servicios</h1>
        <small class="muted">Gesti√≥n de inventario y cat√°logo</small>
      </div>
      <div class="acciones">
        <button 
          *ngIf="canCreate()"
          class="btn btn--primary" 
          type="button" 
          (click)="openModal()" 
          aria-label="Agregar nuevo producto">
          <span aria-hidden="true">+</span> Nuevo Producto
        </button>
      </div>
    </header>

    <section class="filtros card">
      <label>
        <span>üîç Buscar producto</span>
        <input 
          type="text" 
          placeholder="Buscar por nombre o c√≥digo interno..." 
          [ngModel]="busqueda()" 
          (ngModelChange)="busqueda.set($event); currentPage.set(1)"
          aria-label="Campo de b√∫squeda de productos" />
      </label>
    </section>

    <section class="tabla" aria-label="Lista de productos">
      <ng-container *ngIf="filtered().length; else vacio">
        <div class="table card">
          <div class="row header">
            <div>#</div>
            <div>C√≥digo</div>
            <div>Unidad</div>
            <div>Nombre</div>
            <div>Historial</div>
            <div>Stock</div>
            <div>Precio</div>
            <div>IGV</div>
            <div>Serie</div>
            <div>Acciones</div>
          </div>
          <div class="row" role="row" *ngFor="let p of paginatedProducts(); let i = index" [class.alt]="i % 2 === 1">
            <div class="row-number">{{ (currentPage() - 1) * itemsPerPage + i + 1 }}</div>
            <div class="row-code">
              <span class="code-value">{{ p.codigoInterno }}</span>
            </div>
            <div class="row-unit">{{ p.unidad }}</div>
            <div class="row-name">
              <span class="name-value">{{ p.nombre }}</span>
            </div>
            <div class="row-history">
              <span class="muted">{{ p.historial || '‚Äî' }}</span>
            </div>
            <div class="row-stock">
              <span *ngIf="p.stock !== undefined" class="stock-value">{{ p.stock }}</span>
              <span *ngIf="p.stock === undefined" class="muted">‚Äî</span>
            </div>
            <div class="row-price">
              <span class="price-value">S/ {{ p.precio1 | number:'1.2-2' }}</span>
            </div>
            <div class="row-igv">
              <span class="badge badge--small" [class.badge--success]="p.tieneIGV" [class.badge--muted]="!p.tieneIGV">
                {{ p.tieneIGV ? 'S√≠' : 'No' }}
              </span>
            </div>
            <div class="row-serie">
              <span *ngIf="p.manejaSerie && p.serie && p.serie.length > 0" class="badge badge--small badge--info">
                üì¶ {{ p.serie.length }}
              </span>
              <span *ngIf="!p.manejaSerie" class="muted">‚Äî</span>
            </div>
            <div class="acciones-row">
              <button 
                class="btn btn--small btn--info" 
                type="button" 
                (click)="openAlmacenesModal(p)"
                aria-label="Ver almacenes del producto {{ p.nombre }}">
                üè™ Almacenes
              </button>
              <button 
                *ngIf="canModify()"
                class="btn btn--small btn--secondary" 
                type="button" 
                (click)="openModal(p)"
                aria-label="Editar producto {{ p.nombre }}">
                ‚úèÔ∏è Editar
              </button>
              <button 
                *ngIf="canDelete()"
                class="btn btn--small btn--danger" 
                type="button" 
                (click)="deleteProducto(p.id)"
                aria-label="Eliminar producto {{ p.nombre }}">
                üóëÔ∏è Eliminar
              </button>
            </div>
          </div>
        </div>

        <div class="pagination" *ngIf="totalPages() > 1">
          <button class="pagination-btn" [disabled]="currentPage() === 1" (click)="previousPage()" aria-label="P√°gina anterior">
            ‚Äπ
          </button>
          <button 
            *ngFor="let page of pageNumbers()" 
            class="pagination-btn" 
            [class.active]="currentPage() === page"
            (click)="goToPage(page)"
            [attr.aria-label]="'Ir a p√°gina ' + page"
            [attr.aria-current]="currentPage() === page ? 'page' : null">
            {{ page }}
          </button>
          <button class="pagination-btn" [disabled]="currentPage() === totalPages()" (click)="nextPage()" aria-label="P√°gina siguiente">
            ‚Ä∫
          </button>
        </div>
        <div class="pagination-info">
          Mostrando {{ (currentPage() - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage() * itemsPerPage, filtered().length) }} de {{ filtered().length }} productos
        </div>
      </ng-container>
      <ng-template #vacio>
        <div class="callout" role="status">No hay productos que coincidan con la b√∫squeda.</div>
      </ng-template>
    </section>
  </main>
</section>

<div class="modal-overlay" *ngIf="showModal()" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editingProducto() ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
      <button class="btn btn--secondary modal-close-btn" type="button" (click)="closeModal()" aria-label="Cerrar modal">‚úï</button>
    </div>
    <div class="modal-body">
      <form class="product-form" (ngSubmit)="saveProducto()">
        <div class="form-grid">
          <div class="form-group">
            <label for="codigoInterno">
              <span>üè∑Ô∏è C√≥digo Interno</span>
              <span class="required">*</span>
            </label>
            <input 
              id="codigoInterno"
              type="text" 
              [ngModel]="formData().codigoInterno" 
              (ngModelChange)="updateFormField('codigoInterno', $event)" 
              required
              placeholder="Ej: PROD-001"
              autocomplete="off" />
          </div>
          
          <div class="form-group">
            <label for="nombre">
              <span>üì¶ Nombre del Producto</span>
              <span class="required">*</span>
            </label>
            <input 
              id="nombre"
              type="text" 
              [ngModel]="formData().nombre" 
              (ngModelChange)="updateFormField('nombre', $event)" 
              required
              placeholder="Nombre del producto o servicio"
              autocomplete="off" />
          </div>
          
          <div class="form-group">
            <label for="unidad">
              <span>üìè Unidad de Medida</span>
              <span class="required">*</span>
            </label>
            <select 
              id="unidad"
              [ngModel]="formData().unidad" 
              (ngModelChange)="updateFormField('unidad', $event)">
              <option value="UN">Unidad (UN)</option>
              <option value="KG">Kilogramo (KG)</option>
              <option value="LT">Litro (LT)</option>
              <option value="SRV">Servicio (SRV)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="stock">
              <span>üìä Stock</span>
            </label>
            <input 
              id="stock"
              type="number" 
              step="1" 
              min="0" 
              [ngModel]="formData().stock" 
              (ngModelChange)="updateFormField('stock', $event ? +$event : 0)"
              placeholder="0" />
          </div>
          
          <div class="form-group">
            <label for="precio1">
              <span>üí∞ Precio 1</span>
              <span class="required">*</span>
            </label>
            <div class="input-with-prefix">
              <span class="input-prefix">S/</span>
              <input 
                id="precio1"
                type="number" 
                step="0.01" 
                min="0" 
                [ngModel]="formData().precio1" 
                (ngModelChange)="updateFormField('precio1', +$event)" 
                required
                placeholder="0.00" />
            </div>
          </div>
          
          <div class="form-group">
            <label for="precio2">
              <span>üí∞ Precio 2</span>
              <span class="required">*</span>
            </label>
            <div class="input-with-prefix">
              <span class="input-prefix">S/</span>
              <input 
                id="precio2"
                type="number" 
                step="0.01" 
                min="0" 
                [ngModel]="formData().precio2" 
                (ngModelChange)="updateFormField('precio2', +$event)" 
                required
                placeholder="0.00" />
            </div>
          </div>
          
          <div class="form-group">
            <label for="precio3">
              <span>üí∞ Precio 3</span>
            </label>
            <div class="input-with-prefix">
              <span class="input-prefix">S/</span>
              <input 
                id="precio3"
                type="number" 
                step="0.01" 
                min="0" 
                [ngModel]="formData().precio3" 
                (ngModelChange)="updateFormField('precio3', $event ? +$event : undefined)"
                placeholder="0.00 (opcional)" />
            </div>
          </div>
          
          <div class="form-group">
            <label for="historial">
              <span>üìù Historial</span>
            </label>
            <input 
              id="historial"
              type="text" 
              [ngModel]="formData().historial" 
              (ngModelChange)="updateFormField('historial', $event)" 
              placeholder="Ej: √öltima compra: 15/03/2024"
              autocomplete="off" />
          </div>
          
          <div class="form-group form-group--full checkbox-group">
            <div class="checkbox-card">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  [checked]="formData().tieneIGV" 
                  (change)="updateFormField('tieneIGV', $any($event.target).checked)" />
                <span class="checkbox-text">
                  <strong>¬øTiene IGV?</strong>
                  <small class="muted">El producto est√° sujeto al Impuesto General a las Ventas</small>
                </span>
              </label>
            </div>
          </div>
          
          <div class="form-group form-group--full checkbox-group">
            <div class="checkbox-card">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  [checked]="formData().manejaSerie" 
                  (change)="toggleManejaSerie()" />
                <span class="checkbox-text">
                  <strong>¬øManeja Serie?</strong>
                  <small class="muted">Marque esta opci√≥n si el producto requiere control por n√∫mero de serie individual (Ej: Silla, Monitor, etc.)</small>
                </span>
              </label>
            </div>
          </div>

          <div class="form-group form-group--full almacenes-section" *ngIf="canModify() || canCreate()">
            <label>
              <span>üè™ Almacenes</span>
              <small class="muted">Seleccione los almacenes donde estar√° disponible este producto</small>
            </label>
            <div class="almacenes-grid">
              <div class="almacen-select-card" *ngFor="let almacen of getAlmacenes()">
                <label class="almacen-checkbox-label">
                  <input 
                    type="checkbox" 
                    [checked]="estaAlmacenSeleccionado(almacen.id)"
                    (change)="toggleAlmacen(almacen.id)" />
                  <div class="almacen-info">
                    <div class="almacen-header-info">
                      <span class="almacen-name">{{ almacen.nombre }}</span>
                      <span class="almacen-code">{{ almacen.codigo }}</span>
                    </div>
                    <div class="almacen-stock-input" *ngIf="estaAlmacenSeleccionado(almacen.id)">
                      <label class="stock-label">
                        <span>Stock inicial:</span>
                        <input 
                          type="number" 
                          step="1" 
                          min="0" 
                          [value]="getStockAlmacen(almacen.id)"
                          (input)="actualizarStockAlmacen(almacen.id, +$any($event.target).value)"
                          placeholder="0" />
                      </label>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
          <div class="form-group form-group--full" *ngIf="!canModify() && !canCreate()">
            <div class="no-permission-card">
              <span class="muted">üîí No tienes permisos para asignar productos a almacenes</span>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn--secondary" type="button" (click)="closeModal()" aria-label="Cancelar y cerrar modal">
        Cancelar
      </button>
      <button 
        *ngIf="canModify() || (!editingProducto() && canCreate())"
        class="btn btn--primary" 
        type="button" 
        (click)="saveProducto()" 
        aria-label="Guardar producto">
        üíæ Guardar Producto
      </button>
      <div *ngIf="!canModify() && editingProducto()" class="no-permission-message">
        <span class="muted">üîí No tienes permisos para modificar productos</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Almacenes de un Producto -->
<div class="modal-overlay" *ngIf="showAlmacenesModal()" (click)="closeAlmacenesModal()">
  <div class="modal modal-almacenes" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üè™ Almacenes - {{ productoAlmacenes()?.nombre }}</h2>
      <button class="btn btn--secondary modal-close-btn" type="button" (click)="closeAlmacenesModal()" aria-label="Cerrar modal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="producto-info">
        <div class="info-item">
          <span class="info-label">C√≥digo:</span>
          <span class="info-value">{{ productoAlmacenes()?.codigoInterno }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Nombre:</span>
          <span class="info-value">{{ productoAlmacenes()?.nombre }}</span>
        </div>
      </div>
      
      <div class="almacenes-list" *ngIf="getAlmacenesDeProducto(productoAlmacenes()!.id).length > 0; else sinAlmacenes">
        <div class="almacen-item" *ngFor="let item of getAlmacenesDeProducto(productoAlmacenes()!.id)">
          <div class="almacen-header">
            <h3>{{ item.almacen.nombre }}</h3>
            <span class="stock-badge">{{ item.stock }} {{ productoAlmacenes()?.unidad }}</span>
          </div>
          <div class="almacen-details">
            <div class="detail-row">
              <span class="detail-label">C√≥digo Almac√©n:</span>
              <span class="detail-value">{{ item.almacen.codigo }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Stock Disponible:</span>
              <span class="detail-value stock-value">{{ item.stock }} {{ productoAlmacenes()?.unidad }}</span>
            </div>
          </div>
        </div>
      </div>
      <ng-template #sinAlmacenes>
        <div class="empty-state">
          <p>Este producto no est√° disponible en ning√∫n almac√©n.</p>
        </div>
      </ng-template>
    </div>
    <div class="modal-footer">
      <button class="btn btn--primary" type="button" (click)="closeAlmacenesModal()">Cerrar</button>
    </div>
  </div>
</div>